"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const d=require("path"),f=require("fs-extra");function p(a){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a){for(const t in a)if(t!=="default"){const i=Object.getOwnPropertyDescriptor(a,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:()=>a[t]})}}return e.default=a,Object.freeze(e)}const c=p(f),w=new Error("request for lock canceled");var v=function(a,e,t,i){function n(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function l(r){try{u(i.next(r))}catch(h){o(h)}}function _(r){try{u(i.throw(r))}catch(h){o(h)}}function u(r){r.done?s(r.value):n(r.value).then(l,_)}u((i=i.apply(a,e||[])).next())})};class b{constructor(e,t=w){this._value=e,this._cancelError=t,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((t,i)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:t,reject:i}),this._dispatch()})}runExclusive(e,t=1){return v(this,void 0,void 0,function*(){const[i,n]=yield this.acquire(t);try{return yield e(i)}finally{n()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(t=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(t),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(t=>t.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let t=this._value;t>0;t--){const i=(e=this._weightedQueues[t-1])===null||e===void 0?void 0:e.shift();if(!i)continue;const n=this._value,s=t;this._value-=t,t=this._value+1,i.resolve([n,this._newReleaser(s)])}this._drainUnlockWaiters()}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(t=>t()),this._weightedWaiters[e-1]=[])}}var m=function(a,e,t,i){function n(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function l(r){try{u(i.next(r))}catch(h){o(h)}}function _(r){try{u(i.throw(r))}catch(h){o(h)}}function u(r){r.done?s(r.value):n(r.value).then(l,_)}u((i=i.apply(a,e||[])).next())})};class y{constructor(e){this._semaphore=new b(1,e)}acquire(){return m(this,void 0,void 0,function*(){const[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const g={array:()=>Array(),string:()=>String(),number:()=>Number()};class E{mutex=new y;scheme;db_path;constructor(e,t){this.scheme=e,this.db_path=t||process.cwd()}get_db_path(){return d.join(this.db_path,"database.json")}async get_db(){const e=this.get_db_path();if(await c.ensureFile(e),!await c.pathExists(e))throw new Error("failed to create db file");try{return JSON.parse(await c.readFile(e,"utf8"))}catch{}return Object()}async save_db(e){await this.mutex.runExclusive(async()=>{const t=this.get_db_path(),i=d.join(t,"..","database_bak.json");await c.pathExists(t)&&await c.copyFile(t,i),await c.writeFile(t,JSON.stringify(e),{flag:"w+"});try{JSON.parse(await c.readFile(t,"utf8"))}catch(n){console.error("rollback",n.message??n.toString()),await c.move(i,t,{overwrite:!0})}})}init_empty_value(e){return g[this.scheme[e]]()}async get_value(e){let i=(await this.get_db())[e];return i==null&&(i=this.init_empty_value(e)),i}async set_value(e,t){const i=await this.get_db();i[e]=t,await this.save_db(i)}}exports.storage_helper=E;
